{% extends 'layout_narrow.html' %}
{% load static %}
{% load floreal_filters %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'index' %}">Accueil</a></li>
<li class="breadcrumb-item"><a href="{% url 'network_admin' network=dv.network.id %}">Réseau {{dv.network.name}}</a></li>
{% endblock %}

{% block head %}
<style type="text/css">
    ol.progtrckr { margin: 0; padding: 0; list-style-type: none; }
    ol.progtrckr li { display: inline-block; text-align: center; line-height: 3em; width: 15%; font-size: 10px; }
    ol.progtrckr li.progtrckr-True { color: black; border-bottom: 4px solid #811305; }
    ol.progtrckr li.progtrckr-False { color: silver; border-bottom: 4px solid silver; }
    ol.progtrckr li.progtrckr-True:before { content: "\2713"; color: white; background-color: #811305;
        height: 1.2em; width: 1.2em; line-height: 1.2em; border: none; border-radius: 1.2em; }
    ol.progtrckr li.progtrckr-False:before {
        content: "\039F"; color: silver; background-color: white; font-size: 1.5em; bottom: -1.6em;}
    ol.progtrckr li:before { position: relative; bottom: -2.5em; float: left; left: 50%; line-height: 1em; }
    ol.progtrckr li:after { content: "\00a0\00a0"; }

    tr.network-row {  border: 1px solid #811305; }

</style>
<script type='text/javascript'>
    // <![CDATA[
    /* Demand confirmation through a dialog before following link. */
    $(function(){
        $("a.confirm").on('click', function(x) {
            return confirm($(this).attr('msg'));
        })
    })
    // ]]>
</script>
{% endblock %}

{% block content %}

<h2>{{dv.name}}</h2>

<p> {### DESCRIPTION ###}
    Vous êtes administrateur pour la commande {{dv.name}}, qui est
    {% if dv.state == Delivery.PREPARATION %}
    <em>en préparation</em> : les membres n'ont pas encore été autorisés à commander.
    {% elif dv.state == Delivery.ORDERING_ALL %}
    <em>en cours</em> : tous les membres peuvent passer commande.
    {% elif dv.state == Delivery.ORDERING_ADMIN %}
    <em>réservée aux admins</em> : ils peuvent modifier les achats des membres,
    mais les membres normaux ne peuvent plus commander ou modifier eux-mêmes.
    {% elif dv.state == Delivery.FROZEN %}
    <em>envoyée et gelée</em> : la commande a été envoyée au producteur, plus personne ne peut la modifier
    {% elif dv.state == Delivery.TERMINATED %}
    <em>terminée</em>.
    {% endif %}
</p>

<h2>Changer l'état de la commande</h2>
<ol class="progtrckr" data-progtrckr-steps="6">
    {% for x in steps %}
    <li id="progtrckr-{{x.s}}" class="progtrckr-{{x.is_done}}">
        {% if x.is_current %}
        {{x.text}}
        {% else %}
        <a href="{% url 'set_delivery_state' delivery=dv.id state=x.s %}?next={% url 'edit_delivery_staff' delivery=dv.id %}">{{x.text}}</a>
        {% endif %}
    </li>
    {% endfor %}
</ol>

<p>&nbsp;</p>

<h2>Autres actions</h2>
<ul>
    {% if CAN_EDIT_PRODUCTS %}
    <li><a href="{% url 'edit_delivery_products' delivery=dv.id %}">
        Modifier les produits proposés <img src="{% static 'images/edit.png' %}"/>
    </a></li>
    {% endif %}
    {% if CAN_EDIT_PURCHASES %}
    {% if networks|length > 1 %}
    <li>Modifier les achats <img src="{% static 'images/edit.png' %}"/>
        <ul>
            {% for nw in networks %}
            <li>
                <a href="{% url 'edit_delivery_purchases' delivery=dv.id network=nw.id %}">
                    Pour {{nw.name}}
                </a>
            </li>
            {% endfor %}
        </ul>
    </li>
    {% else %}{# one network #}
    <li><a href="{% url 'edit_delivery_purchases' delivery=dv.id network=networks.0.id %}">
        Modifier les achats <img src="{% static 'images/edit.png' %}"/>
    </a></li>
    {% endif %}{# 1 or several networks #}
    {% endif %}{# CAN_EDIT_XXX #}

    {### VIEW AND EDIT PURCHASES ###}
    {% if dv.state != Delivery.TERMINATED %}
    {% if networks|length == 0 %}
    <!-- Aucun sous-groupe visualisable -->
    {% elif networks|length == 1 %}
    {% with networks.0 as nw %}
    <li>Voir les commandes :
        <ul>
            <li>
                <a href="{% url 'view_network_purchases_html' delivery=dv.id network=nw.id %}">en ligne <img src="{% static 'images/grid.png' %}"/></a>,
            </li>
            <li>
                <a href="{% url 'view_network_purchases_xlsx' delivery=dv.id network=nw.id %}">en tableau Excel <img src="{% static 'images/excel.png' %}"/></a>,
            </li>
            <li>
                <a href="{% url 'view_network_purchases_latex' delivery=dv.id network=nw.id %}">en table PDF <img src="{% static 'images/pdf.png' %}"/></a>,
            </li>
            <li>
                <a href="{% url 'view_network_purchases_cards' delivery=dv.id network=nw.id %}">en fiches individuelles <img src="{% static 'images/pdf.png' %}"/></a>
            </li>
        </ul>
    </li>
    {% endwith %}
    {% else %}{# networks|length > 1 #}
    <li>Voir {%if CAN_EDIT_PURCHASES%} ou modifier {% endif %} les commandes :</li>
    <table>
        <tr><td></td><th>En ligne</th><th>Excel</th><th>PDF</th><th>Fiches</th>
            {% if CAN_EDIT_PURCHASES%}<th>Éditer</th>{% endif %}
        </tr>
        {% for nw in networks %}
        <tr>
            <th class="left">Sous-groupe {{sg.name}}</th>
            <td><a href="{% url 'view_network_purchases_html' delivery=dv.id network=nw.id %}"><img src="{% static 'images/grid.png' %}"/</a></td>
            <td><a href="{% url 'view_network_purchases_xlsx' delivery=dv.id network=nw.id  %}"><img src="{% static 'images/excel.png' %}"/></a></td>
            <td><a href="{% url 'view_network_purchases_latex' delivery=dv.id network=nw.id  %}"><img src="{% static 'images/pdf.png' %}"/></a></td>
            <td><a href="{% url 'view_network_purchases_cards' delivery=dv.id network=nw.id  %}"><img src="{% static 'images/pdf.png' %}"/></a></td>
            {% if CAN_EDIT_PURCHASES %}
            {% for nw in networks %}
            <!-- Non! ca rallonge le tableau ! -->
            <td><a href="{% url 'edit_delivery_purchases' delivery=dv.id network=nw.id %}"><img src="{%  static 'images/edit.png'%}"/></a></td>
            {% endfor %}
            {% endif %}
        </tr>
        {% endfor %}{# nw #}
        <tr class="network-row">
            <th class="left">Tout le réseau {{dv.network.name}}</th>
            <td><a href="{% url 'view_delivery_purchases_html' delivery=dv.id %}"><img src="{% static 'images/grid.png' %}"/</a></td>
            <td><a href="{% url 'view_delivery_purchases_xlsx' delivery=dv.id %}"><img src="{% static 'images/excel.png' %}"/></a></td>
            <td><a href="{% url 'view_delivery_purchases_latex' delivery=dv.id %}"><img src="{% static 'images/pdf.png' %}"/></a></td>
            <td><a href="{% url 'view_delivery_purchases_cards' delivery=dv.id %}"><img src="{% static 'images/pdf.png' %}"/></a></td>
            {%if CAN_EDIT_PURCHASES%}<td><!-- pas d'edition pour tout le reseau --> - </td>{%endif%}
        </tr>
    </table>
    {% endif %}{# networks.length > 1#}
    {% endif %}{# ! Delivery.TERMINATED #}
</ul>
{% endblock %}