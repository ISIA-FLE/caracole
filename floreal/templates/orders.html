{% extends 'layout.html' %}
{% load static %}
{% load floreal_filters %}

{% block document_ready %}
{% endblock %}

{% block content %}
<section class="container margetopXl margebot">
    {% for m in general_messages %}
    {{m|safe}}
    {% endfor %}
    
    <h1>Commandes en cours</h1>

    <div class="container slim margetop">
      {% for nw in networks %}

      {% if forloop.counter > 1 %}
      <!-- TODO séparateur entre réseaux -->
      {% endif %}

      <a id="{{nw.slug}}"></a>

      {% if nw.messages|length == 1 %}
      <div class="">
        <strong>Message des responsables du réseau {{nw.name}} :</strong> {{nw.messages.0|safe}}
      </div>
      {% elif nw.messages|length > 1 %}
      <div class=""><strong>Messages des responsables du réseau {{nw.name}} :</strong></div>
      {% for m in nw.messages %}
      <div class="">{{m|safe}}</div>
      {% endfor %}
      {% endif %}

      {% for dv in nw.deliveries %}
      {% if dv.purchases or dv.state == Delivery.ORDERING_ALL %}
      {% with has_freeze_date=dv.freeze|is_in_the_future has_distribution_date=dv.distribution %}
      <ul class="commandes">
        <li>
            {% if dv.state > Delivery.ORDERING_ALL %}
            <span class="jours">{{dv.state_name}}</span>  
            {% elif has_freeze_date %}
            <span class="jours" data-toggle="tooltip" title="Commander jusqu'au {{dv.freeze}}">
            J - {{dv.freeze|days_until}}
            </span>
            {% else %}
            <span class="jours" data-toggle="tooltip" title="Date de clôture des commandes non renseignée">
            ?
            </span>
            {% endif %}          
          {% if dv.state == Delivery.ORDERING_ALL %}
          <a href="{% url 'buy' delivery=dv.id %}">
          {% endif %}
            <span class="couleur-prim">
            {% if has_distribution_date %}{{dv.distribution|short_date}} | {% endif %}
            {{nw.name}} |
            </span>
            {{dv.name}} 
          {% if dv.state == Delivery.ORDERING_ALL %}
          </a>
          {% endif %}
        </li>
          <ul>
            {% for pc in dv.purchases %}
            <li><strong>{{pc.quantity|floatformat}}</strong>{{pc.unit|unit_multiple}} de <strong>{{pc.name}}</strong></li>
            {% endfor %}
            {% if dv.total_price %} <span class="prix">{{dv.total_price|price}}</span> {% endif %}
          </ul>
      </ul>
      {% endwith %}{# has_freeze_date has_distribution_date #}
      {% endif %} {# can order or has ordered #}
      {% endfor %}{# delivery #}
      {% endfor %}{# network #}
    </div>

    <div class="container slim margetop">
      <ul>
        <li> <a href="{% url 'view_history' %}">Historique des commandes passées</a> </li>
      </ul>
    </div>

  </section>

{% endblock %}