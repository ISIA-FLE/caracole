{% extends 'layout.html' %}
{% load static %}
{% load floreal_filters %}


{% block head %}
<style type="text/css">
  td.product-image img {
    object-fit: contain;
    object-position: center;
    width: 93px;
    height: 93px;
  }
</style>
 
<script type='text/javascript'>

  let DATA;
  let PRODUCTS = {}; // id -> product record

  /* Load products, delivery, and saved purchases description */
  async function load_purchases() {
    const res = await fetch("{% url 'user_purchases_json' delivery=delivery.id %}");
    DATA = await res.json();
    //SOME_PACKAGED = DATA.products.find(pd => pd.quantity_per_package !== null) !== undefined;
    //SOME_WEIGHTED = DATA.products.find(pd => pd.unit_weight !== 0) !== undefined;
    DATA.products.forEach(pd => { PRODUCTS[pd.id] = pd; })
  }

  /* TODO: add multiplication/pluralization when applicable. */
  function render_unit(u) { return u; }

  /* Reflect the content of `DATA` into widgets. */
  function render() {
    $("#delivery-name").text(DATA.delivery.name);
    $("#delivery-id").val(DATA.delivery.id);
    $("#network-name").text(DATA.network.name);
    $("#user-name").text(DATA.user.first_name + " " + DATA.user.last_name);
    if (DATA.delivery.description) {
      $("#delivery-description").html(DATA.delivery.description);
    }

    let rows = ``;
    DATA.products.forEach((pd, i) => {
      const pc = pd.purchase;
      //const parity = i%2 ? "odd" : "even";
      let input;
      if (pc.max_quantity === 0) {
        rows += `<tr><td colspan="5" class="out-of-stock">(Produit épuisé)</td></tr>`;
      } else {
        rows += `
            <tr id="row-${pd.id}" class="row-produit">
              <td rowspan="${pd.description ? 2 : 1}" class="product-image">
                ${pd.image ? '<img src="' + pd.image + '"/>' : ''}
              </td>
              <td class="product-name">${pd.name}</td>
              <td class="quantity">
                <input
                  class="ordered_quantity"
                  maxlength="64"
                  name="pd-${pd.id}"
                  type="number"
                  step="${pd.quantum}"
                  min="0"
                  max="${pd.purchase.max_quantity}"
                  value="${pd.purchase.quantity}"
                />
                <div class="quantity-nav">
                  <div class="quantity-button quantity-up">+</div>
                  <div class="quantity-button quantity-down">-</div>
                </div>
                </td>
              <td class="product-unit"> ${render_unit(pd.unit)}</td>
              <td class="unit-price">${pd.price.toFixed(2)} € / ${pd.unit}</td>
              <td class="price">${pc.price.toFixed(2)} €</td>
            </tr>`;
        if (pd.description) rows += `
            <tr class="texte-produit">
              <td colspan="5">
                ${pd.description}
              </td>
            </tr>`;
      }
    });
    $("#products-table tbody").append(rows);
    /* Now let's wire the up/down buttons with the matching inputs. */
    $('.row-produit').each(function () {
      const row = $(this);
      const pd_id = Number(row.attr('id').split("-")[1]);
      const input = row.find('input[type="number"]');
      const max = input.attr('max');
      const quantum = PRODUCTS[pd_id].quantum;
      row.find('.quantity-up').click(function () {
        const oldValue = parseFloat(input.val());
        const newValue = (oldValue >= max) ? oldValue : oldValue + quantum;
        row.find("input").val(newValue);
        row.find("input").trigger("change");
      });
      row.find('.quantity-down').click(function () {
        const oldValue = parseFloat(input.val());
        const newValue = oldValue < quantum ? oldValue : oldValue - quantum;
        row.find("input").val(newValue);
        row.find("input").trigger("change");
      });
    });
    $(".quantity input").change(recompute);
    recompute();
  }

  function recompute() {
    let total_price = 0;
    //let total_weight = 0;
    $(".row-produit").each(function (i, e) {
      const row = $(e);
      const id = Number(row.attr('id').split("-")[1]);
      const q = Number(row.find("input").val());
      const pd = PRODUCTS[id];
      const pc = pd.purchase;
      const price = q * pd.price;
      row.find(".price").text(price.toFixed(2));
      total_price += price;
      //total_weight += q * pd.unit_weight;
    });
    $(".total_price").text(total_price.toFixed(2));
    //$(".total_weight").text(total_weight.toFixed(0));
  }

  function reset_order(id) {
    $(`[name=pd-${id}]`).val(0);
    recompute();
  }

  function confirm_cancel() {
    if (confirm("Annuler les modifications de la commande ?")) {
      window.history.back();
    }
  }
  $(document).ready(async () => {
    /* Turn plain inputs into Bootstrap inputs. */
    await load_purchases();
    render();
    /* Recompute totals after each change as well as after laoding. */
  });
</script>
{% endblock %}


{% block content %}
<section class="container margetopXl margebot">
  <h1 class=" h2-like couleur-prim"><span id='delivery-date'>—</span> | <span id='delivery-name'>...</span></h1>
  <h3><span id='network-name'>...</span></h3>

  <div class="container margetop row stretch cent">
    <p class="commandes-detail-intro" id="delivery-description">
    </p>
    <!-- Ne faire apparaitre que s'il y a une photo -->
    <div class="photo-producteur" id="producer-image" style="background-image:url('/static/images/index-intro.jpg');
                  background-size: cover; 
                  background-position: center;"></div>
    <!-- end -->
  </div>

  <div class="container">

    <form method="POST">

      <table id="products-table">
        <tbody>

          <tr>
            <th></th>
            <th>Produit</th>
            <th colspan="2">Quantité</th>
            <th>Prix unitaire</th>
            <th>Sous-Total</th>
          </tr>

          <tr class="total">
            <td colspan="4"></td>
            <td class="total-padding">Total</td>
            <td class="total_cell"><span class="total_price">0.00</span>&nbsp;€</td>
          </tr>

          <!--
          <tr class="total-padding">
            <td colspan="4"></td>
            <td>Poid total</td>
            <td class="total_cell"><span class="total_weight">0</span>&nbsp;kg</td>
          </tr>
          -->

        </tbody>
      </table>

      <div class="row container xslim">
        <input class="button-primary" type="submit" value="Valider la commande">
        <a class="button retour" href="javascript:confirm_cancel()">Retour</a>
      </div>
      <input type='hidden' id='delivery-id' name='delivery-id' value='...' />
      {% csrf_token %}  
    </form>
  </div>

</section>
{% endblock %}