{% extends 'layout.html' %}
{% load static %}

{% block head %}

<style type="text/css">
  #user-form td:first-child {
    text-align: right;
  }
  .coord {
    width: unset !important;
  }
</style>

<script src="{% static 'tinymce/tinymce.min.js' %}"></script>
<script src="{% static 'tinymce/jquery.tinymce.min.js' %}"></script>

<script type='text/javascript'>

  let CURRENT_USER = null;
  let MODIFIED_USER = false;
  let USERS = {}; // id -> user record
  let NETWORKS = {}; // id -> network record

  async function load_users() {
    const response = await fetch("{% url 'users_json' %}");
    const data = await response.json();
    const select = $("#users");
    data.users.forEach(u => {
      select.append(`
      <option 
        data-tokens="${u.email}"
        data-subtext="${u.email}" 
        value="${u.id}"">
        ${u.first_name} ${u.last_name}
      </option>`)
      USERS[u.id] = u;
    });
    data.networks.forEach(nw => {
      NETWORKS[nw.id] = nw;
    });
    select.selectpicker(); // Force rendering of dynamically added picker
    $("#loading-spinner").remove();
    select.on("change", (event) => {
      const u = USERS[event.target.value];
      if (MODIFIED_USER) {
        if (confirm(
          "Sauvegarder d'abord les modifications pour " +
          CURRENT_USER.first_name + " " + CURRENT_USER.last_name + " ?"
        )) {
          // TODO wait for result?
          save_changes();
        }
      }
      render_user(u);
      CURRENT_USER = u;
      MODIFIED_USER = false;
      $("#user-form").show();
    })

    const oui_non = (name) => `<input
      class="user-modifier"
      name="${name}" 
      type="checkbox" 
      data-toggle="toggle" 
      data-on="Oui" 
      data-off="Non"
    />`;

    let template = data.networks.map(nw => `
      <tr>
        <th colspan="2">Réseau ${nw.name} (${nw.id})</th>
      </tr>
      <tr>
        <td>Acheteur:</td>
        <td>${oui_non("buyer-" + nw.id)}</td>
      </tr>
      <tr>
        <td>Admin réseau:</td>
        <td>${oui_non("staff-" + nw.id)}</td>
      </tr>
      <tr    result.florealuser__latitude = $("florealuser__latitude").val();
    result.florealuser__longitude = $("florealuser__longitude").val();
>
        <td>Producteur:</td>
        <td>${oui_non("producer-" + nw.id)}</td>
      </tr>
      <tr>
        <td>Régulateur:</td>
        <td>${oui_non("regulator-" + nw.id)}</td>
      </tr>`).join("\n");

    if (data.is_staff) {
      template += `
      <tr>
        <th colspan="2">Administrateur global?</th>
      </tr>
      <tr>
        <td></td>
        <td>${oui_non("is_staff")}</td>
      </tr>
      <!--<tr><td colspan="2">
        <button 
          id="deactivate"
          class="btn btn-block btn-danger">
          Désactiver le compte
        </button>
      </td></tr>-->`;
    }
    template += `
    <tr><td colspan="2">
      <button id="save" type="button" class="btn btn-block btn-primary">Sauvegarder</button>
    </td></tr>`;

    // Insert and force bootstrap-style toggle look&feel
    $("#user-form")
      .append(template)
      .hide(); // will be shown upon user selection
    $("#user-form [type=checkbox]").bootstrapToggle();
    // Bootstrap toggle layout is buggy inside tables.
    $("#user-form div.toggle").css("width", "58").css("height", "36")

    $(".user-modifier").on('change keyup', () => {
      // Once modifications occurred, saving them to server becomes allowed
      if (!MODIFIED_USER && CURRENT_USER) {
        console.log(`user ${CURRENT_USER.id} is now modified`);
        MODIFIED_USER = true;
        $("#save").prop("disabled", false);
      }
    });
    $("#save").on("click", (event) => {
      event.preventDefault();
      save_changes();
    });
    $("#deactivate").on("click", () => {
      if (confirm(
        `Désactiver complètement et définitivement le compte de ` +
        CURRENT_USER.first_name + " " + CURRENT_USER.last_name + " ?")) {
        console.log("TODO deactivate, deselect user (from select + hide form)");
      }
    });
  }

  /* Modify the HTML widgets so that they reflect user `u`'s state
   * according to JSON DB. */
  function render_user(u) {
    console.log("Rendering user ", u);
    Object.values(NETWORKS).forEach(nw =>
      ["buyer", "staff", "producer", "regulator"].forEach(field =>
        $(`[name=${field}-${nw.id}]`).bootstrapToggle(u[field].includes(nw.id) ? "on" : "off")
      )
    );
    $(`[name=is_staff]`).bootstrapToggle(u.is_staff ? "on" : "off");
    tinyMCE.get("description").setContent(u.florealuser__description || "");
    const img_url = u['florealuser__image_description']?.url || "/media/none.png";
    $("#image").attr("src", img_url);
    $("[name=florealuser__phone]").val(u.florealuser__phone);
    $("[name=florealuser__latitude]").val(u.florealuser__latitude);
    $("[name=florealuser__longitude]").val(u.florealuser__longitude);
    $("#save").prop("disabled", true); // will be re-enabled upon modification
  }

  /* Send current user modifications to server. */
  function save_changes() {
    const add_spinner = () => {
      $("#save").prop("disabled", true);
      $("#save").html(
        `<span id = "save-spinner" class="spinner-border spinner-border-sm"></span>
      Sauvegarder ${CURRENT_USER.first_name} ${CURRENT_USER.last_name}`);
    };
    const remove_spinner = () =>
      $("#save").html(`Sauvegarder`);

    const data = get_data();
    add_spinner();
    $.ajax({
      url: 'users.json',
      type: 'POST',
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify(data),
      success: () => {
        remove_spinner();
        // Reflect changes from `data` into local users table, in case it's reloaded.
        Object.entries(data).forEach(([name, val]) => { CURRENT_USER[name] = val; })
        MODIFIED_USER = false;
      },
      error: (result) => {
        alert("Failed, see the console");
        console.log("Save request failed:", result);
        remove_spinner();
        $("#save").prop("disabled", false);
      }
    });
  }

  /* Get data from HTML input, return it as a JSON object
   * ready to be sent to server. */
  function get_data() {
    if (CURRENT_USER === null || !MODIFIED_USER) { return null; }

    const get_number = (element) => {
      const bits = element.getAttribute('name').split("-");
      return Number(bits[bits.length - 1]);
    }

    const result = {
      user: CURRENT_USER.id,
      networks: Object.keys(NETWORKS).map(Number),
      florealuser__description: tinyMCE.get("description").getContent(),
      florealuser__image_description: CURRENT_USER.florealuser__image_description,
      florealuser__latitude: Number($("[name=florealuser__latitude]").val()),
      florealuser__longitude: Number($("[name=florealuser__longitude]").val()),
      florealuser__phone: $("[name=florealuser__longitude]").val(),
    };

    ['buyer', 'staff', 'producer', 'regulator'].forEach(field => {
      result[field] = [];
      $(`input[name^=${field}-]`).each((_, x) => {
        if (x.checked) {
          result[field].push(get_number(x));
        }
      })
    });

    if ($("[name=is_staff]").length > 0) {
      result['is_staff'] = $("[name=is_staff]")[0].checked;
    }

    return result;
  }

  /* File readers are asynchronous, but don't support modern async/await format. */
  get_image_name_and_content = (file) => new Promise((resolve, reject) => {
    if(! file) { return [null, null]; }
    const reader = new FileReader();
    reader.onload = () => {
      resolve([file.name, reader.result]);
    };
    reader.onerror = reject;
    reader.readAsBinaryString(file);
  })
  
  async function on_image_change(event) {
    const file = event.target.files[0];
    const [name, content] = await get_image_name_and_content(file);
    const img = $("#image")[0]
    if(null === content) { return; }
    img.src = URL.createObjectURL(file);
    CURRENT_USER["florealuser__image_description"] = {name, content};
  }

  $(document).ready(async () => {
    const url = new URL(window.location);
    const selected = url.searchParams.get("selected");
    tinymce.init({
      plugins: 'link',
      selector: 'textarea',
      content_css: "/static/floreal.css",
      language: 'fr_FR',
      init_instance_callback: (editor) => {
        editor.on('keydown', (event) => {
          if (!MODIFIED_USER && CURRENT_USER) {
            console.log(`user ${CURRENT_USER.id} is now modified`);
            MODIFIED_USER = true;
            $("#save").prop("disabled", false);
          }
        })
      }
    });
    await load_users();
    if(selected) {
      setTimeout(() => {
        $("#users").val(selected);
        $("#users").selectpicker("refresh");
        const u = USERS[selected];
        render_user(u);
        CURRENT_USER = u;
        MODIFIED_USER = false;
        $("#user-form").show();

      }, 0);
    } else {
      // Open the selection widget; won't work synchronously,
      // hence the async setTimeout()
      setTimeout(() => $("#users").selectpicker("toggle"), 0);
    }
  })

</script>
{% endblock %}

{% block content %}
<section class="container margetopXl margebot">
  <h1>Gestion des utilisateurs</h1>
  <h3>Selection de l'utilisateur :</h3>
  <p>
    <span id="loading-spinner" class="spinner-border spinner-border-sm"></span>
    <select id="users" title="Choisir un utilisateur" data-live-search="true" data-show-subtext="true" style="display: none">
    </select>
  </p>

  <h3>Description de l'utilisateur / producteur</h3>
  <div>
    <label for="latitude">Téléphone : </label>
    <input type="text" name="florealuser__phone" id="phone" class="coord user-modifier"/>
  </div>
  <div>
    Position géographique :
    <label for="latitude">Latitude = </label>
    <input type="number" name="florealuser__latitude" id="latitude" step="any" class="coord user-modifier" min="-90" max="90"/>
    <label for="longitude">Longitude = </label>
    <input type="number" name="florealuser__longitude" id="longitude" step="any" class="coord user-modifier" min="-180" max="180"/>
  </div>  


  <div>
    Photo :
    <label for="image-input">
    {# TODO pass image.url from python, use it if applicable #}
    <img id="image" src=""/>
    </label>
  </div>
  <div>
    <input 
      type="file" 
      accept="image/*" 
      class="user-modifier"
      name="image" 
      id="image-input" 
      onchange="on_image_change(event)"/>
  </div>

  <textarea id="description"></textarea>

  <table id="user-form"></table>
</section>
{% endblock %}